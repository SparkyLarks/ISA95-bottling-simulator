[{"id":"FFF0000000000001","type":"tab","label":"FlowFuse Device Flow","disabled":false,"info":""},{"id":"9abf2871e1274867","type":"tab","label":"ğŸ­ Context Setup","disabled":false,"info":""},{"id":"8690c76610b14835","type":"tab","label":"ğŸ“¡ Modbus â†’ MQTT","disabled":false,"info":""},{"id":"34ada4dca404476c","type":"mqtt-broker","name":"MonsterMQ","broker":"${MQTT_HOST}","port":"${MQTT_PORT}","clientid":"nr-bottling-line","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":false,"birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":false,"closePayload":"","willTopic":"","willQos":"0","willRetain":false,"willPayload":"","sessionExpiry":""},{"id":"835de58eb8af84ff","type":"modbus-client","name":"Bottling Line 1 Demo","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"queueLogEnabled":false,"failureLogEnabled":true,"tcpHost":"${MODBUS_HOST}","tcpPort":"${MODBUS_PORT}","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":9600,"serialDatabits":8,"serialStopbits":1,"serialParity":"none","serialConnectionDelay":100,"serialAsciiResponseStartDelimiter":"0x3A","unit_id":1,"commandDelay":1,"clientTimeout":"10000","reconnectOnTimeout":true,"reconnectTimeout":2000,"parallelUnitIdsAllowed":true,"showErrors":false,"showWarnings":true,"showLogs":true},{"id":"6844975363baa690","type":"mqtt-broker","name":"MonsterMQ Hardcode","broker":"192.168.137.5","port":1883,"clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":60,"cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"FFCOM00000000001","type":"comment","z":"FFF0000000000001","name":"Welcome to Node-RED by FlowFuse! \\n This is a basic starter flow for your new device, to get you started.","info":"","x":310,"y":80,"wires":[]},{"id":"FFINJ00000000001","type":"inject","z":"FFF0000000000001","name":"On Start","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0.2","topic":"","payload":"true","payloadType":"bool","x":140,"y":160,"wires":[["FFCHA00000000001"]]},{"id":"FFCHA00000000001","type":"change","z":"FFF0000000000001","name":"Get Env Vars","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.device","pt":"msg","to":"FF_DEVICE_NAME","tot":"env"},{"t":"set","p":"payload.application","pt":"msg","to":"FF_APPLICATION_NAME","tot":"env"}],"action":"","reg":false,"x":320,"y":160,"wires":[["FFDBG00000000001"]]},{"id":"FFDBG00000000001","type":"debug","z":"FFF0000000000001","name":"Info","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":490,"y":160,"wires":[]},{"id":"99c560a679b14098","type":"inject","z":"9abf2871e1274867","name":"Set context on start","repeat":"","once":true,"onceDelay":"0.5","payload":"","payloadType":"date","x":120,"y":100,"wires":[["1554962021ac4fde"]]},{"id":"1554962021ac4fde","type":"function","z":"9abf2871e1274867","name":"Set ISA-95 Global Context","func":"\nconst ctx = {\n    enterprise: env.get(\"ENTERPRISE\") || \"Aerogen\",\n    site:       env.get(\"SITE\")       || \"Shannon\",\n    area:       env.get(\"AREA\")       || \"Bottling\",\n    line:       env.get(\"LINE\")       || \"Line01\",\n    loadedAt:   new Date().toISOString()\n};\nglobal.set(\"isa95\", ctx);\nnode.status({ fill:\"green\", shape:\"dot\",\n    text: ctx.enterprise + \"/\" + ctx.site + \"/\" + ctx.area + \"/\" + ctx.line });\nnode.log(\"ISA-95 context: \" + JSON.stringify(ctx));\nmsg.payload = ctx;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":100,"wires":[[]]},{"id":"3d62ebe3d1b94614","type":"inject","z":"9abf2871e1274867","name":"Load lookup tables","repeat":"","once":true,"onceDelay":"0.8","payload":"","payloadType":"date","x":120,"y":200,"wires":[["466683e40fe841e4"]]},{"id":"466683e40fe841e4","type":"function","z":"9abf2871e1274867","name":"SKU + State + Stop Code Tables","func":"\nglobal.set(\"skuTable\", {\n    0:  \"LEM-200-IE\", 1: \"LEM-500-IE\", 2: \"LEM-2L-IE\",  3: \"LEM-6L-IE\",\n    4:  \"DL-200-IE\",  5: \"DL-500-IE\",  6: \"COL-500-IE\", 7: \"COL-2L-IE\",\n    8:  \"DC-500-IE\",  9: \"DC-500-UK\",  65535: \"IDLE\"\n});\nglobal.set(\"lineStateTable\", {\n    0:\"IDLE\", 1:\"RUNNING\", 2:\"MICROSTOP\",\n    3:\"STOPPED\", 4:\"FAULT\", 5:\"CHANGEOVER\", 6:\"CIP\"\n});\nglobal.set(\"stopCodeTable\", {\n    0:null,\n    1:\"MS01\",2:\"MS02\",3:\"MS03\",4:\"MS04\",5:\"MS05\",\n    6:\"MS06\",7:\"MS07\",8:\"MS08\",9:\"MS09\",10:\"MS10\",\n    11:\"ST01\",12:\"ST02\",13:\"ST03\",14:\"ST04\",15:\"ST05\",\n    16:\"ST06\",17:\"ST07\",18:\"ST08\",19:\"ST09\",20:\"ST10\",\n    21:\"BD-M1\",22:\"BD-M2\",23:\"BD-M3\",\n    24:\"BD-MINOR-PE\",25:\"BD-MINOR-LS\",26:\"BD-MINOR-CA\"\n});\nnode.status({ fill:\"green\", shape:\"dot\", text:\"Tables loaded\" });\nreturn null;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":200,"wires":[[]]},{"id":"96ec4af3da4246cb","type":"comment","z":"9abf2871e1274867","name":"Required Environment Variables","info":"Set in FlowFuse â†’ Device â†’ Environment Variables:\n\nENTERPRISE   = Aerogen\nSITE         = Shannon\nAREA         = Bottling\nLINE         = Line01\nMODBUS_HOST  = 192.168.137.4\nMODBUS_PORT  = 5020\nMQTT_HOST    = 192.168.137.5\nMQTT_PORT    = 1883\n","x":120,"y":320,"wires":[]},{"id":"619aadc8dfe844f6","type":"inject","z":"8690c76610b14835","name":"Poll 500ms","repeat":"0.5","once":true,"onceDelay":"2","payload":"","payloadType":"date","x":100,"y":120,"wires":[[]]},{"id":"09e77bc9742846fa","type":"modbus-read","z":"8690c76610b14835","name":"Read 56 Registers","topic":"","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"showWarnings":true,"unitid":"1","dataType":"HoldingRegister","adr":"0","quantity":"56","rate":"500","rateUnit":"ms","delayOnStart":false,"enableDeformedMessages":false,"startDelayTime":"","server":"835de58eb8af84ff","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":300,"y":120,"wires":[["9f76ef1823c64848","de34b0aabd981e0b","112c66f0bd220fc3","53ef0c26128f8455"],[]]},{"id":"9f76ef1823c64848","type":"function","z":"8690c76610b14835","name":"Parse â†’ Telemetry Messages Edge","func":"\nconst regs = msg.payload;\nif (!regs || regs.length < 56) { node.warn(\"Short read: \" + (regs||[]).length); return null; }\n\n// Decode helpers\nfunction f32(hi, lo) {\n    const b = Buffer.alloc(4);\n    b.writeUInt16BE(hi,0); b.writeUInt16BE(lo,2);\n    return b.readFloatBE(0);\n}\nfunction u32(hi, lo) { return (hi << 16) | lo; }\nfunction fix(v, d) { return +v.toFixed(d||3); }\n\nconst ts  = new Date().toISOString();\nconst ctx = global.get(\"isa95\") || { enterprise:\"Aerogen\", site:\"Shannon\", area:\"Bottling\", line:\"Line01\" };\nconst base = `telemetry/${ctx.enterprise}/${ctx.site}/${ctx.area}/${ctx.line}/Edge`;\n\n// Parse registers\nconst parsed = {\n    // Line01\n    \"Line01/line_state\":          regs[0],\n    \"Line01/line_speed_bpm\":      fix(f32(regs[1],regs[2])),\n    \"Line01/good_count\":          u32(regs[3],regs[4]),\n    \"Line01/reject_count\":        u32(regs[5],regs[6]),\n    \"Line01/order_seq\":           regs[11],\n    \"Line01/sku_index\":           regs[8],\n    \"Line01/stop_code\":           regs[9],\n    \"Line01/fault_code\":          regs[10],\n    // Infeed01\n    \"Infeed01/bottle_presence\":   regs[14],\n    \"Infeed01/infeed_rate_bpm\":   fix(f32(regs[15],regs[16])),\n    \"Infeed01/starved\":           regs[17],\n    \"Infeed01/jam_detected\":      regs[18],\n    // Filler01\n    \"Filler01/target_weight_g\":   fix(f32(regs[20],regs[21]),2),\n    \"Filler01/actual_weight_g\":   fix(f32(regs[22],regs[23]),2),\n    \"Filler01/fill_time_ms\":      u32(regs[24],regs[25]),\n    \"Filler01/scale_stable\":      regs[26],\n    \"Filler01/drip_sensor\":       regs[27],\n    // Capper01\n    \"Capper01/torque_target_ncm\": fix(f32(regs[29],regs[30]),2),\n    \"Capper01/torque_actual_ncm\": fix(f32(regs[31],regs[32]),2),\n    \"Capper01/torque_in_spec\":    regs[33],\n    \"Capper01/cap_feed_ok\":       regs[34],\n    // Checkweigher01\n    \"Checkweigher01/gross_weight_g\":  fix(f32(regs[36],regs[37]),2),\n    \"Checkweigher01/weight_in_spec\":  regs[38],\n    \"Checkweigher01/rezero_active\":   regs[39],\n    // Labeller01\n    \"Labeller01/label_applied\":     regs[41],\n    \"Labeller01/label_sensor_ok\":   regs[42],\n    \"Labeller01/label_stock_level\": regs[43],\n    // Scanner01\n    \"Scanner01/barcode_read_ok\":  regs[45],\n    \"Scanner01/rescan_count\":     regs[46],\n    // Labeller02\n    \"Labeller02/hazard_label_required\": regs[48],\n    \"Labeller02/hazard_label_applied\":  regs[49],\n    \"Labeller02/hazard_label_stock\":    regs[50],\n    // RejectPusher01\n    \"RejectPusher01/reject_triggered\":  regs[52],\n    \"RejectPusher01/reject_reason\":     regs[53],\n    \"RejectPusher01/pusher_cycle_ms\":   u32(regs[54],regs[55])\n};\n\n// Save snapshot for status display\nflow.set(\"snap\", {\n    ts,\n    lineState:  regs[0],\n    lineStateName: (global.get(\"lineStateTable\")||{})[regs[0]] || \"?\",\n    sku:        (global.get(\"skuTable\")||{})[regs[8]] || \"?\",\n    goodCount:  u32(regs[3],regs[4]),\n    rejCount:   u32(regs[5],regs[6])\n});\n\n// Build one msg per signal\nconst messages = Object.entries(parsed).map(([suffix, v]) => ({\n    topic:   `${base}/${suffix}`,\n    payload: JSON.stringify({ ts, v, q:\"GOOD\", src:\"sim\" }),\n    qos: 0,\n    retain: false\n}));\n\nmsg.payload = messages;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":140,"wires":[["409ce81e404e49c8"]]},{"id":"409ce81e404e49c8","type":"function","z":"8690c76610b14835","name":"Fan out","func":"\nif (!Array.isArray(msg.payload)) return null;\nmsg.payload.forEach(m => node.send({ topic: m.topic, payload: m.payload, qos:0, retain:false }));\nreturn null;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":80,"wires":[["c6d0940a59ba45ed"]]},{"id":"c6d0940a59ba45ed","type":"mqtt out","z":"8690c76610b14835","name":"â†’ MonsterMQ","topic":"","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6844975363baa690","x":1180,"y":120,"wires":[]},{"id":"07b809c54cf44ad3","type":"inject","z":"8690c76610b14835","name":"Status 1s","repeat":"1","once":true,"onceDelay":"3","payload":"","payloadType":"date","x":100,"y":240,"wires":[["b048bf278d034350"]]},{"id":"b048bf278d034350","type":"function","z":"8690c76610b14835","name":"Line Status","func":"\nconst s = flow.get(\"snap\");\nif (!s) { node.status({fill:\"grey\",shape:\"ring\",text:\"waiting...\"}); return null; }\nconst col = {RUNNING:\"green\",IDLE:\"grey\",MICROSTOP:\"yellow\",\n             STOPPED:\"red\",FAULT:\"red\",CHANGEOVER:\"blue\",CIP:\"blue\"}[s.lineStateName]||\"grey\";\nnode.status({fill:col, shape:\"dot\",\n    text:`${s.lineStateName} | ${s.sku} | âœ“${s.goodCount} âœ—${s.rejCount}`});\nreturn null;\n","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":240,"wires":[]},{"id":"b1c23b23f33648bc","type":"comment","z":"8690c76610b14835","name":"Topic format: telemetry/{enterprise}/{site}/{area}/{line}/{station}/{signal}","info":"One message per signal per 500ms poll. TVQ payload: {ts, v, q, src}","x":330,"y":340,"wires":[]},{"id":"de34b0aabd981e0b","type":"function","z":"8690c76610b14835","name":"Parse Modbus data for Raw","func":"const ts  = new Date().toISOString();\nconst ctx = global.get(\"isa95\") || { enterprise:\"Amarach\", site:\"Crosshaven\", area:\"Bottling\", line:\"Line01\" };\nconst base = `telemetry/${ctx.enterprise}/${ctx.site}/${ctx.area}/${ctx.line}`;\nconst suffix = 'Edge/Raw'\nconst payload = msg.payload\n\nmsg.topic  = `${base}/${suffix}`,\nmsg.payload = JSON.stringify({ ts, payload, q:\"GOOD\", src:\"sim\" })\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":180,"wires":[["c6d0940a59ba45ed"]]},{"id":"112c66f0bd220fc3","type":"function","z":"8690c76610b14835","name":"Parese Decode Context","func":"const regs = msg.payload;\nif (!regs || regs.length < 56) return null;\n\nfunction f32(hi, lo) {\n    const b = Buffer.alloc(4);\n    b.writeUInt16BE(hi,0); b.writeUInt16BE(lo,2);\n    return b.readFloatBE(0);\n}\nfunction u32(hi, lo) { return (hi << 16) | lo; }\nfunction fix(v, d) { return +v.toFixed(d||3); }\n\nconst ts  = new Date().toISOString();\nconst ctx = global.get(\"isa95\") || { enterprise:\"Amarach\", site:\"Crosshaven\", area:\"Bottling\", line:\"Line01\" };\nconst base = `telemetry/${ctx.enterprise}/${ctx.site}/${ctx.area}/${ctx.line}`;\n\nconst skuTbl   = global.get(\"skuTable\")       || {};\nconst stateTbl = global.get(\"lineStateTable\") || {};\nconst stopTbl  = global.get(\"stopCodeTable\")  || {};\n\nconst faultNames = { 0:null, 1:\"BD-M1 Filler Scale\", 2:\"BD-M2 Capper Torque\", 3:\"BD-M3 Checkweigher\" };\nconst rejectNames = { 0:null, 1:\"weight\", 2:\"torque\", 3:\"barcode\", 4:\"label\", 5:\"hazard_label\" };\n\nfunction tvq(v, u) {\n    return JSON.stringify({ ts, v, q:\"GOOD\", src:\"sim\", u: u||\"\" });\n}\n\nconst parsed = {\n    // General â€” decoded\n    \"General/line_state\":     tvq(stateTbl[regs[0]]          || regs[0]),\n    \"General/sku\":            tvq(skuTbl[regs[8]]            || regs[8]),\n    \"General/stop_code\":      tvq(stopTbl[regs[9]]           || null),\n    \"General/fault_code\":     tvq(faultNames[regs[10]]       || null),\n    \"General/line_speed_bpm\": tvq(fix(f32(regs[1],regs[2]))),\n    \"General/good_count\":     tvq(u32(regs[3],regs[4]),      \"btl\"),\n    \"General/reject_count\":   tvq(u32(regs[5],regs[6]),      \"btl\"),\n    \"General/order_seq\":      tvq(regs[11]),\n\n    // Infeed01\n    \"Infeed01/bottle_presence\":  tvq(regs[14] === 1),\n    \"Infeed01/infeed_rate_bpm\":  tvq(fix(f32(regs[15],regs[16])), \"bpm\"),\n    \"Infeed01/starved\":          tvq(regs[17] === 1),\n    \"Infeed01/jam_detected\":     tvq(regs[18] === 1),\n\n    // Filler01\n    \"Filler01/target_weight_g\":  tvq(fix(f32(regs[20],regs[21]),2), \"g\"),\n    \"Filler01/actual_weight_g\":  tvq(fix(f32(regs[22],regs[23]),2), \"g\"),\n    \"Filler01/fill_time_ms\":     tvq(u32(regs[24],regs[25]),        \"ms\"),\n    \"Filler01/scale_stable\":     tvq(regs[26] === 1),\n    \"Filler01/drip_sensor\":      tvq(regs[27] === 1),\n\n    // Capper01\n    \"Capper01/torque_target_ncm\": tvq(fix(f32(regs[29],regs[30]),2), \"Ncm\"),\n    \"Capper01/torque_actual_ncm\": tvq(fix(f32(regs[31],regs[32]),2), \"Ncm\"),\n    \"Capper01/torque_in_spec\":    tvq(regs[33] === 1),\n    \"Capper01/cap_feed_ok\":       tvq(regs[34] === 1),\n\n    // Checkweigher01\n    \"Checkweigher01/gross_weight_g\": tvq(fix(f32(regs[36],regs[37]),2), \"g\"),\n    \"Checkweigher01/weight_in_spec\": tvq(regs[38] === 1),\n    \"Checkweigher01/rezero_active\":  tvq(regs[39] === 1),\n\n    // Labeller01\n    \"Labeller01/label_applied\":     tvq(regs[41] === 1),\n    \"Labeller01/label_sensor_ok\":   tvq(regs[42] === 1),\n    \"Labeller01/label_stock_level\": tvq(regs[43], \"%\"),\n\n    // Scanner01\n    \"Scanner01/barcode_read_ok\": tvq(regs[45] === 1),\n    \"Scanner01/rescan_count\":    tvq(regs[46]),\n\n    // Labeller02\n    \"Labeller02/hazard_label_required\": tvq(regs[48] === 1),\n    \"Labeller02/hazard_label_applied\":  tvq(regs[49] === 1),\n    \"Labeller02/hazard_label_stock\":    tvq(regs[50], \"%\"),\n\n    // RejectPusher01\n    \"RejectPusher01/reject_triggered\": tvq(regs[52] === 1),\n    \"RejectPusher01/reject_reason\":    tvq(rejectNames[regs[53]] || null),\n    \"RejectPusher01/pusher_cycle_ms\":  tvq(u32(regs[54],regs[55]), \"ms\")\n};\n\nconst messages = Object.entries(parsed).map(([suffix, payload]) => ({\n    topic:   `${base}/${suffix}`,\n    payload, qos: 0, retain: false\n}));\n\nmsg.payload = messages;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":80,"wires":[["409ce81e404e49c8"]]},{"id":"53ef0c26128f8455","type":"function","z":"8690c76610b14835","name":"Build Historian","func":"// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Build Historian v2 â€” Full signal coverage\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst regs = msg.payload;\nif (!regs || regs.length < 56) return null;\n\nconst ts = Date.now();\n\nfunction f32(hi, lo) {\n    const b = Buffer.alloc(4);\n    b.writeUInt16BE(hi, 0); b.writeUInt16BE(lo, 2);\n    return b.readFloatBE(0);\n}\nfunction u32(hi, lo) { return (hi << 16) | lo; }\nfunction fix(v, d) { return +v.toFixed(d || 3); }\n\nconst ctx = global.get(\"isa95\") || {\n    enterprise: \"Amarach\", site: \"Crosshaven\", area: \"Bottling\", line: \"Line01\"\n};\nconst base = `historian/${ctx.enterprise}/${ctx.site}/${ctx.area}/${ctx.line}`;\n\nconst skuTbl = global.get(\"skuTable\") || {};\nconst stateTbl = global.get(\"lineStateTable\") || {};\nconst stopTbl = global.get(\"stopCodeTable\") || {};\nconst faultNames = { 0: null, 1: \"BD-M1 Filler Scale\", 2: \"BD-M2 Capper Torque\", 3: \"BD-M3 Checkweigher\" };\nconst rejectNames = { 0: null, 1: \"weight\", 2: \"torque\", 3: \"barcode\", 4: \"label\", 5: \"hazard_label\" };\n\nfunction tvq(v) {\n    return JSON.stringify({ timestamp: ts, value: v });\n}\n\nconst historian = {\n\n    // General\n    \"General/line_state\": tvq(stateTbl[regs[0]] || regs[0]),\n    \"General/sku\": tvq(skuTbl[regs[8]] || regs[8]),\n    \"General/stop_code\": tvq(stopTbl[regs[9]] || null),\n    \"General/fault_code\": tvq(faultNames[regs[10]] || null),\n    \"General/line_speed_bpm\": tvq(fix(f32(regs[1], regs[2]))),\n    \"General/good_count\": tvq(u32(regs[3], regs[4])),\n    \"General/reject_count\": tvq(u32(regs[5], regs[6])),\n    \"General/order_seq\": tvq(regs[11]),\n\n    // Infeed01\n    \"Infeed01/bottle_presence\": tvq(regs[14] === 1),\n    \"Infeed01/infeed_rate_bpm\": tvq(fix(f32(regs[15], regs[16]))),\n    \"Infeed01/starved\": tvq(regs[17] === 1),\n    \"Infeed01/jam_detected\": tvq(regs[18] === 1),\n\n    // Filler01\n    \"Filler01/target_weight_g\": tvq(fix(f32(regs[20], regs[21]), 2)),\n    \"Filler01/actual_weight_g\": tvq(fix(f32(regs[22], regs[23]), 2)),\n    \"Filler01/fill_time_ms\": tvq(u32(regs[24], regs[25])),\n    \"Filler01/scale_stable\": tvq(regs[26] === 1),\n    \"Filler01/drip_sensor\": tvq(regs[27] === 1),\n\n    // Capper01\n    \"Capper01/torque_target_ncm\": tvq(fix(f32(regs[29], regs[30]), 2)),\n    \"Capper01/torque_actual_ncm\": tvq(fix(f32(regs[31], regs[32]), 2)),\n    \"Capper01/torque_in_spec\": tvq(regs[33] === 1),\n    \"Capper01/cap_feed_ok\": tvq(regs[34] === 1),\n\n    // Checkweigher01\n    \"Checkweigher01/gross_weight_g\": tvq(fix(f32(regs[36], regs[37]), 2)),\n    \"Checkweigher01/weight_in_spec\": tvq(regs[38] === 1),\n    \"Checkweigher01/rezero_active\": tvq(regs[39] === 1),\n\n    // Labeller01\n    \"Labeller01/label_applied\": tvq(regs[41] === 1),\n    \"Labeller01/label_sensor_ok\": tvq(regs[42] === 1),\n    \"Labeller01/label_stock_level\": tvq(regs[43]),\n\n    // Scanner01\n    \"Scanner01/barcode_read_ok\": tvq(regs[45] === 1),\n    \"Scanner01/rescan_count\": tvq(regs[46]),\n\n    // Labeller02\n    \"Labeller02/hazard_required\": tvq(regs[48] === 1),\n    \"Labeller02/hazard_applied\": tvq(regs[49] === 1),\n    \"Labeller02/hazard_label_stock\": tvq(regs[50]),\n\n    // RejectPusher01\n    \"RejectPusher01/reject_triggered\": tvq(regs[52] === 1),\n    \"RejectPusher01/reject_reason\": tvq(rejectNames[regs[53]] || null),\n    \"RejectPusher01/pusher_cycle_ms\": tvq(u32(regs[54], regs[55])),\n};\n\nconst messages = Object.entries(historian).map(([suffix, payload]) => ({\n    topic: `${base}/${suffix}`,\n    payload,\n    qos: 1,\n    retain: false\n}));\n\nmsg.payload = messages;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":20,"wires":[["409ce81e404e49c8"]]},{"id":"dd3a57f77cec8cae","type":"global-config","env":[],"modules":{"node-red-contrib-modbus":"5.45.2"}}]